#!/bin/bash

# ==============================================================================
# SCRIPT UNIVERSAL DE DESBLOQUEIO PODMAN - V2 (ROBUSTO)
# ==============================================================================

# Definição de Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_succ() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[CORRIGINDO]${NC} $1"; }
log_err()  { echo -e "${RED}[ERRO]${NC} $1"; }

echo -e "${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}   FERRAMENTA DE DESBLOQUEIO GERAL DE CONTAINERS (V2)        ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

# 1. LIMPEZA DE AMBIENTE (AGORA VEM PRIMEIRO)
# ------------------------------------------------------------------------------
log_info "Preparando o terreno (Passo Crítico)..."

# Mata processos auxiliares que podem estar segurando o banco de dados
pkill -9 crun 2>/dev/null
pkill -9 conmon 2>/dev/null
log_succ "Processos órfãos encerrados."

# Tenta migrar o estado do banco de dados (A CORREÇÃO DO SEU ERRO)
log_warn "Executando 'system migrate' para corrigir status inválidos..."
podman system migrate 2>/dev/null
if [ $? -eq 0 ]; then
    log_succ "Migração de sistema realizada."
else
    log_warn "Migração retornou erro ou não era necessária."
fi

# 2. LIMPEZA DE ARQUIVOS TEMPORÁRIOS GLOBAIS
# ------------------------------------------------------------------------------
# Movemos isso para antes do loop, pois se o lock estiver aqui, o 'ps' nunca funciona.
RUN_ROOT="/var/tmp/podman-static/1000"

if [ -d "$RUN_ROOT" ]; then
    log_warn "Detectado cache temporário em $RUN_ROOT."
    log_warn "Tentando limpar travas de sistema (pode pedir senha sudo)..."
    
    # Tenta remover sem sudo primeiro (caso seja dono), se falhar, tenta sudo
    rm -rf "$RUN_ROOT" 2>/dev/null || sudo rm -rf "$RUN_ROOT"
    
    if [ ! -d "$RUN_ROOT" ]; then
        log_succ "Cache temporário limpo."
    else
        log_err "Não foi possível remover $RUN_ROOT. Verifique permissões."
    fi
fi

# 3. LISTAGEM E CORREÇÃO INDIVIDUAL
# ------------------------------------------------------------------------------
log_info "Agora mapeando containers..."

# O comando ps agora tem mais chance de funcionar
ALL_CONTAINERS=$(podman ps -a --format "{{.ID}} {{.Names}}")

if [ -z "$ALL_CONTAINERS" ]; then
    log_succ "Nenhum container encontrado ou listagem falhou. O ambiente foi limpo acima."
    exit 0
fi

COUNT=$(echo "$ALL_CONTAINERS" | wc -l)
log_info "Encontrados $COUNT container(s). Verificando estados..."

while IFS= read -r line; do
    CID=$(echo $line | awk '{print $1}')
    NAME=$(echo $line | awk '{print $2}')
    
    echo -e "${BLUE}--- Processando: ${YELLOW}$NAME${NC} ($CID)"
    
    # Cleanup individual
    podman container cleanup "$CID" >/dev/null 2>&1
    
    # Force Stop
    podman stop --force --time 0 "$CID" >/dev/null 2>&1
    
    # Verificação
    CURRENT_STATUS=$(podman inspect --format '{{.State.Status}}' "$CID" 2>/dev/null)
    if [[ "$CURRENT_STATUS" =~ ^(exited|created|configured)$ ]]; then
        log_succ "Status: $CURRENT_STATUS"
    else
        log_err "Status: $CURRENT_STATUS"
    fi

done <<< "$ALL_CONTAINERS"

# 4. FINAL
# ------------------------------------------------------------------------------
echo -e "\n${GREEN}Procedimento concluído.${NC}"
echo "Tente iniciar seus containers agora."
