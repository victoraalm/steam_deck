#!/bin/bash

# ==============================================================================
# SCRIPT UNIVERSAL DE DESBLOQUEIO PODMAN (SEM DELEÇÃO)
# ==============================================================================
# Alvo: TODOS os containers instalados.
# Ação: Forçar sincronização de estado e limpeza de processos zumbis.
# Segurança: NENHUM comando 'rm' é executado nos dados dos containers.
# ==============================================================================

# Definição de Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_succ() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[CORRIGINDO]${NC} $1"; }
log_err()  { echo -e "${RED}[ERRO]${NC} $1"; }

echo -e "${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}   FERRAMENTA DE DESBLOQUEIO GERAL DE CONTAINERS             ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

# Limpa a variavel que causa os erros visuais
unset LD_PRELOAD

# 1. LISTAGEM GERAL
# ------------------------------------------------------------------------------
log_info "Mapeando todos os containers do sistema..."

# Formato: ID e NOME. O loop vai ler linha por linha.
ALL_CONTAINERS=$(podman ps -a --format "{{.ID}} {{.Names}}")

if [ -z "$ALL_CONTAINERS" ]; then
    log_succ "Nenhum container encontrado no Podman. Nada a fazer."
    exit 0
fi

COUNT=$(echo "$ALL_CONTAINERS" | wc -l)
log_info "Foram encontrados $COUNT container(s). Iniciando varredura..."

# 2. LIMPEZA DE PROCESSOS SOLTOS (PREPARAÇÃO)
# ------------------------------------------------------------------------------
# Mata processos auxiliares que podem estar segurando os containers
log_info "Encerrando processos órfãos (crun/conmon)..."
pkill -9 crun 2>/dev/null
pkill -9 conmon 2>/dev/null

# 3. LOOP DE CORREÇÃO (UM POR UM)
# ------------------------------------------------------------------------------
echo ""
while IFS= read -r line; do
    # Extrai ID e NOME da linha atual
    CID=$(echo $line | awk '{print $1}')
    NAME=$(echo $line | awk '{print $2}')
    
    echo -e "${BLUE}-------------------------------------------------------------${NC}"
    echo -e "Alvo: ${YELLOW}$NAME${NC} (ID: $CID)"
    
    # PASSO A: CLEANUP
    # Remove montagens presas e arquivos de trava internos
    log_warn "Executando limpeza de estado (cleanup)..."
    OUT_CLEAN=$(podman container cleanup "$CID" 2>&1)
    
    if [ $? -eq 0 ]; then
        log_succ "Cleanup realizado."
    else
        # Às vezes falha se o container já estiver muito 'morto', o que é bom
        echo "   > Retorno: $OUT_CLEAN"
    fi
    
    # PASSO B: FORCE STOP
    # Força o banco de dados a aceitar que o container parou
    log_warn "Forçando status 'Stop' no banco de dados..."
    podman stop --force --time 0 "$CID" >/dev/null 2>&1
    
    # PASSO C: VERIFICAÇÃO INDIVIDUAL
    CURRENT_STATUS=$(podman inspect --format '{{.State.Status}}' "$CID" 2>/dev/null)
    if [ "$CURRENT_STATUS" == "exited" ] || [ "$CURRENT_STATUS" == "created" ] || [ "$CURRENT_STATUS" == "configured" ]; then
        log_succ "Status final: $CURRENT_STATUS (Pronto para uso)"
    else
        log_err "Status final: $CURRENT_STATUS (Ainda requer atenção)"
    fi

done <<< "$ALL_CONTAINERS"

# 4. LIMPEZA DE ARQUIVOS TEMPORÁRIOS DO SISTEMA (A SOLUÇÃO CIRÚRGICA)
# ------------------------------------------------------------------------------
echo -e "\n${BLUE}-------------------------------------------------------------${NC}"
log_info "Limpando diretórios temporários globais..."

# Caminho específico onde o Podman Estático guarda os "locks" que causam o erro "Improper"
RUN_ROOT="/var/tmp/podman-static/1000"

if [ -d "$RUN_ROOT" ]; then
    log_warn "Detectado cache temporário em $RUN_ROOT."
    log_warn "Solicitando permissão sudo para remover travas de sistema..."
    
    sudo rm -rf "$RUN_ROOT"
    
    if [ $? -eq 0 ]; then
        log_succ "Cache temporário limpo com sucesso."
    else
        log_err "Falha ao limpar cache. Senha incorreta?"
    fi
else
    log_succ "Cache temporário já estava limpo."
fi

# 5. RELATÓRIO FINAL
# ------------------------------------------------------------------------------
echo -e "\n${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}                  STATUS PÓS-CORREÇÃO                        ${NC}"
echo -e "${YELLOW}=============================================================${NC}"
podman ps -a
echo ""
echo -e "${GREEN}Procedimento concluído.${NC}"
echo "Seus containers estão preservados e destravados."
echo "Tente iniciar seu container agora."
