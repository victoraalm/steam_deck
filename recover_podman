#!/bin/bash
# ==============================================================================
# SCRIPT: PODMAN HEALTH DOCTOR (STEAM DECK/ARCH EDITION)
# VERSÃO: 5.0 (Ultimate Professional)
# AUTOR: Gemini AI (Assistant)
# DESCRIÇÃO: Diagnostica, repara deadlocks e recupera o estado do Podman
#            de forma não-bloqueante e resiliente.
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. CONFIGURAÇÕES GLOBAIS & CONSTANTES
# ------------------------------------------------------------------------------
TIMEOUT_CMD="10s"           # Tempo máximo para esperar um comando responder
USER_ID=$(id -u)            # ID do usuário atual
RUNTIME_DIR="/run/user/$USER_ID"
STORAGE_DIR="$HOME/.local/share/containers/storage"

# Definição de Cores para Logs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Lista de processos que devem ser terminados (ordem de dependência)
PROCESS_LIST=("fuse-overlayfs" "slirp4netns" "rootlessport" "conmon" "crun" "podman")

# Lista de Locais de Bloqueio (Locks) Conhecidos
LOCK_FILES=(
    "$RUNTIME_DIR/libpod/locks"
    "$RUNTIME_DIR/containers/locks"
    "$RUNTIME_DIR/vfs-containers/locks"
    "$RUNTIME_DIR/overlay-containers/locks"
    "$STORAGE_DIR/libpod/locks"
    "$STORAGE_DIR/overlay-containers/locks"
)

# ------------------------------------------------------------------------------
# 2. FUNÇÕES AUXILIARES (HELPERS)
# ------------------------------------------------------------------------------

# Função de Log Padronizado com Timestamp
log() {
    local LEVEL=$1
    local MSG=$2
    local TIMESTAMP=$(date +'%H:%M:%S')
    
    case $LEVEL in
        "INFO") echo -e "${CYAN}[$TIMESTAMP] [INFO]${NC} $MSG" ;;
        "OK")   echo -e "${GREEN}[$TIMESTAMP] [OK]${NC} $MSG" ;;
        "WARN") echo -e "${YELLOW}[$TIMESTAMP] [WARN]${NC} $MSG" ;;
        "ERR")  echo -e "${RED}[$TIMESTAMP] [FAIL]${NC} $MSG" ;;
        *)      echo -e "[$TIMESTAMP] $MSG" ;;
    esac
}

# Função wrapper para executar comandos com timeout
exec_safe() {
    local CMD="$@"
    timeout "$TIMEOUT_CMD" $CMD >/dev/null 2>&1
    local STATUS=$?
    
    if [ $STATUS -eq 124 ]; then
        return 124 # Código para Timeout
    elif [ $STATUS -eq 0 ]; then
        return 0   # Sucesso
    else
        return 1   # Erro genérico
    fi
}

# ------------------------------------------------------------------------------
# 3. EXECUÇÃO DO FLUXO DE TRABALHO (WORKFLOW)
# ------------------------------------------------------------------------------

echo -e "${CYAN}======================================================${NC}"
echo -e "${CYAN}   PODMAN HEALTH DOCTOR - DIAGNÓSTICO E REPARO        ${NC}"
echo -e "${CYAN}======================================================${NC}"
log "INFO" "Iniciando protocolo de reparo para User ID: $USER_ID"

# --- ETAPA 1: NEUTRALIZAÇÃO DE PROCESSOS (Stop the bleeding) ---
log "INFO" "Etapa 1: Neutralizando processos zumbis ou travados..."

for PROC in "${PROCESS_LIST[@]}"; do
    if pgrep -x "$PROC" >/dev/null; then
        killall -9 "$PROC" >/dev/null 2>&1
        log "WARN" "Processo encerrado forçadamente: $PROC"
    else
        # Silencioso se não existir, para não poluir o log
        true 
    fi
done
log "OK" "Ambiente de processos limpo."

# --- ETAPA 2: REMOÇÃO CIRÚRGICA DE LOCKS (Remove the obstruction) ---
log "INFO" "Etapa 2: Verificando arquivos de trava (Locks)..."

LOCKS_REMOVED=0
for LOCK_PATH in "${LOCK_FILES[@]}"; do
    if [ -d "$LOCK_PATH" ] || [ -f "$LOCK_PATH" ]; then
        rm -rf "$LOCK_PATH"
        log "WARN" "Lock removido: $LOCK_PATH"
        LOCKS_REMOVED=$((LOCKS_REMOVED+1))
    fi
done

if [ $LOCKS_REMOVED -eq 0 ]; then
    log "OK" "Nenhum arquivo de trava corrompido encontrado."
else
    log "OK" "Total de travas removidas: $LOCKS_REMOVED"
fi

# Limpeza de Cache Estático (Rootless)
STATIC_RUN="/var/tmp/podman-static/$USER_ID"
if [ -d "$STATIC_RUN" ]; then
    rm -rf "$STATIC_RUN" 2>/dev/null || log "ERR" "Falha ao limpar $STATIC_RUN (permissão?)"
    log "OK" "Cache estático limpo."
fi

# --- ETAPA 3: RECONSTRUÇÃO DO ESTADO (Fix the brain) ---
log "INFO" "Etapa 3: Regenerando consistência do banco de dados..."

# Renumber (Arruma IDs sequenciais)
exec_safe podman system renumber
RET=$?
if [ $RET -eq 124 ]; then
    log "ERR" "Renumber sofreu timeout (O sistema de arquivos ainda pode estar lento)."
elif [ $RET -eq 0 ]; then
    log "OK" "IDs dos containers reordenados."
else
    log "WARN" "Renumber falhou, mas seguiremos."
fi

# Migrate (Atualiza o banco para a versão atual e remove referências velhas)
exec_safe podman system migrate
RET=$?
if [ $RET -eq 124 ]; then
    log "ERR" "Migrate sofreu timeout."
elif [ $RET -eq 0 ]; then
    log "OK" "Banco de dados migrado com sucesso."
fi

# --- ETAPA 4: LIMPEZA DE CONTAINERS DEFEITUOSOS (Clean up the mess) ---
log "INFO" "Etapa 4: Auditando containers restantes..."

# Obtemos a lista de forma segura
CONTAINERS=$(timeout 5s podman ps -a --format "{{.ID}}|{{.Names}}|{{.State.Status}}")

if [ -z "$CONTAINERS" ]; then
    log "OK" "Nenhum container encontrado. O ambiente está limpo (zerado)."
else
    # Processa linha por linha
    echo "$CONTAINERS" | while IFS='|' read -r CID CNAME CSTATUS; do
        if [ -z "$CID" ]; then continue; fi
        
        log "INFO" "Analisando: $CNAME ($CSTATUS)"
        
        # Se status for "dead" ou desconhecido, força limpeza
        exec_safe podman container cleanup "$CID"
        exec_safe podman stop --force --time 0 "$CID"
        
        log "OK" "Container $CNAME higienizado."
    done
fi

# --- ETAPA 5: TESTE FINAL DE SAÚDE (Vital signs check) ---
log "INFO" "Etapa 5: Teste de fumaça (Smoke Test)..."

exec_safe podman info
RET=$?
if [ $RET -eq 0 ]; then
    echo -e "\n${GREEN}======================================================${NC}"
    echo -e "${GREEN}   SUCESSO: O PODMAN ESTÁ OPERACIONAL                 ${NC}"
    echo -e "${GREEN}======================================================${NC}"
    echo "Você pode rodar seus containers agora."
else
    echo -e "\n${RED}======================================================${NC}"
    echo -e "${RED}   ALERTA: O PODMAN AINDA APRESENTA ERROS             ${NC}"
    echo -e "${RED}======================================================${NC}"
    echo "Sugestão: Reinicie o Steam Deck completamente se o erro persistir."
fi

exit 0
