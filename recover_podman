#!/bin/bash

# ==============================================================================
# SCRIPT DE DIAGNÓSTICO E RECUPERAÇÃO DO PODMAN (STEAM DECK / DISTROBOX)
# ==============================================================================
# Objetivo: Destravar containers com status "Stopping", "Improper" ou zumbis.
# Segurança: NUNCA executa 'podman rm'. Seus dados/containers estão seguros.
# Atualização: Verifica e solicita criação de senha sudo se necessário.
# ==============================================================================

# Definição de Cores para facilitar a leitura
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCESSO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[ATENÇÃO]${NC} $1"; }
log_error() { echo -e "${RED}[ERRO]${NC} $1"; }

echo -e "${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}   INICIANDO VERIFICAÇÃO DE SAÚDE DO PODMAN (SEM DELEÇÃO)    ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

# ------------------------------------------------------------------------------
# FASE 0: VERIFICAÇÃO DE PERMISSÕES (NOVO)
# ------------------------------------------------------------------------------
log_info "FASE 0: Verificando requisitos de administrador..."

# Verifica o status da senha do usuário atual
# NP = No Password (Sem senha), P = Password (Com senha), L = Locked
PASS_STATUS=$(passwd -S $(whoami) | awk '{print $2}')

if [ "$PASS_STATUS" == "NP" ]; then
    echo -e "${RED}ERRO: O usuário 'deck' não possui uma senha definida.${NC}"
    log_warn "Para realizar a limpeza profunda (se necessária), o script precisa de permissão 'sudo'."
    echo -e "${YELLOW}Vamos definir uma senha agora.${NC}"
    echo "Digite uma senha segura e pressione Enter (ela não aparecerá na tela):"
    
    passwd
    
    # Verifica se o comando passwd foi bem sucedido
    if [ $? -ne 0 ]; then
        log_error "Falha ao definir a senha. O script será encerrado."
        exit 1
    fi
    log_success "Senha definida com sucesso! Continuando..."
else
    log_success "Usuário possui senha definida. Permissões ok."
fi

# ------------------------------------------------------------------------------
# FASE 1: DIAGNÓSTICO E COLETA DE DADOS
# ------------------------------------------------------------------------------
log_info "FASE 1: Coletando informações do sistema e do Podman..."

# 1. Tenta rodar o system migrate preventivamente (banco de dados)
log_info "Executando 'podman system migrate' para alinhar banco de dados..."
podman system migrate
if [ $? -eq 0 ]; then
    log_success "Migração de banco de dados verificada."
else
    log_warn "A migração retornou um erro, mas continuaremos a análise."
fi

# 2. Identificar onde o Podman guarda os arquivos temporários (O "RunRoot")
log_info "Identificando diretórios de execução (RunRoot) via 'podman info'..."

RUN_ROOT=$(podman info --format '{{.Store.RunRoot}}')

# Fallback para Steam Deck
if [ -z "$RUN_ROOT" ]; then
    log_warn "Não foi possível ler o RunRoot via comando. Assumindo padrão do Steam Deck."
    RUN_ROOT="/var/tmp/podman-static/1000"
fi

log_info "Diretório de arquivos temporários identificado: $RUN_ROOT"

# 3. Rodar debug
log_info "Gerando log de debug (podman info --debug)..."
podman info --debug > podman_debug_log.txt 2>&1
log_success "Log de debug salvo em 'podman_debug_log.txt'."

# ------------------------------------------------------------------------------
# FASE 2: VERIFICAÇÃO DE STATUS E TENTATIVA DE PARADA GENTIL
# ------------------------------------------------------------------------------
log_info "FASE 2: Verificando estado dos containers..."

CONTAINERS=$(podman ps -a --format "{{.ID}} {{.Names}} {{.Status}}")

if [ -z "$CONTAINERS" ]; then
    log_success "Nenhum container encontrado. Nada a corrigir."
    exit 0
fi

echo -e "\nContainers encontrados:"
echo "$CONTAINERS"
echo ""

PRECISA_LIMPEZA=0

while IFS= read -r line; do
    CID=$(echo $line | awk '{print $1}')
    NAME=$(echo $line | awk '{print $2}')
    STATUS=$(echo $line | awk '{$1=""; $2=""; print $0}' | xargs)

    if [[ "$STATUS" == *"Stopping"* ]] || [[ "$STATUS" == *"Improper"* ]] || [[ "$STATUS" == *"Error"* ]]; then
        log_error "Container $NAME ($CID) está com status problemático: $STATUS"
        PRECISA_LIMPEZA=1
    elif [[ "$STATUS" == *"Up"* ]]; then
        log_info "Container $NAME ($CID) está rodando. Tentando parar gentilmente..."
        podman stop -t 5 "$CID" 2>/dev/null
        
        if [ $? -eq 0 ]; then
            log_success "Container $NAME parado com sucesso."
        else
            log_warn "Falha ao parar $NAME gentilmente. Provavelmente travado."
            PRECISA_LIMPEZA=1
        fi
    else
        log_info "Container $NAME ($CID) está parado ou em estado desconhecido ($STATUS)."
    fi
done <<< "$CONTAINERS"

# ------------------------------------------------------------------------------
# FASE 3: A SOLUÇÃO CIRÚRGICA (Se necessário)
# ------------------------------------------------------------------------------

if [ $PRECISA_LIMPEZA -eq 1 ]; then
    echo -e "\n${RED}=============================================================${NC}"
    echo -e "${RED}   DETECTADO BLOQUEIO NO PODMAN - INICIANDO LIMPEZA FORÇADA   ${NC}"
    echo -e "${RED}=============================================================${NC}"
    log_warn "Problemas detectados. Iniciando limpeza profunda..."
    
    # Matar processos
    log_info "Passo 3.1: Matando processos travados (podman/crun/conmon)..."
    pkill -9 podman 2>/dev/null
    pkill -9 crun 2>/dev/null
    pkill -9 conmon 2>/dev/null
    
    # Limpar a sujeira (AQUI USA SUDO)
    log_info "Passo 3.2: Removendo arquivos temporários de estado em: $RUN_ROOT"
    
    if [ -d "$RUN_ROOT" ]; then
        log_warn "Solicitando permissão de administrador (sudo) para limpeza..."
        # Como já garantimos a senha na Fase 0, o usuário saberá o que digitar
        sudo rm -rf "$RUN_ROOT"
        
        if [ $? -eq 0 ]; then
            log_success "Diretório temporário limpo com sucesso."
        else
            log_error "Falha ao limpar $RUN_ROOT. Verifique se digitou a senha correta."
            exit 1
        fi
    else
        log_warn "O diretório $RUN_ROOT não existe ou já foi limpo."
    fi

    log_success "Limpeza concluída. O Podman foi reiniciado."

else
    log_success "Todos os containers estão saudáveis. Nenhuma limpeza necessária."
fi

# ------------------------------------------------------------------------------
# FASE 4: VERIFICAÇÃO FINAL
# ------------------------------------------------------------------------------
echo -e "\n${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}                  STATUS FINAL DO SISTEMA                    ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

podman ps -a
echo -e "\n${GREEN}Concluído.${NC}"
