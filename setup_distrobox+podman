#!/bin/bash

# ==============================================================================
# SMART INSTALLER: DISTROBOX + PODMAN (STEAM DECK)
# ==============================================================================
# Lógica: Verifica versões remotas (GitHub) e compara com as locais.
# Ação: Só baixa/instala se a versão remota for mais nova ou se não existir.
# ==============================================================================

# Cores e Formatação
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_skip() { echo -e "${YELLOW}[PULAR]${NC} $1"; }
log_act() { echo -e "${GREEN}${BOLD}[AÇÃO]${NC} $1"; }

echo -e "${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}   VERIFICAÇÃO INTELIGENTE: DISTROBOX & PODMAN               ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

# ------------------------------------------------------------------------------
# 1. VERIFICAÇÃO DE SENHA (SUDO) - Requisito obrigatório
# ------------------------------------------------------------------------------
log_info "Passo 1/6: Verificando status da senha..."
PASS_STATUS=$(passwd -S $(whoami) | awk '{print $2}')

if [ "$PASS_STATUS" == "NP" ]; then
    echo -e "${RED}ERRO: Senha de usuário não definida.${NC}"
    echo -e "${YELLOW}Defina uma senha agora para permitir configurações do sistema:${NC}"
    passwd
    if [ $? -ne 0 ]; then echo -e "${RED}Senha não criada. Abortando.${NC}"; exit 1; fi
else
    log_skip "Senha já definida."
fi

# ------------------------------------------------------------------------------
# 2. CONFIGURAÇÃO DO PATH
# ------------------------------------------------------------------------------
log_info "Passo 2/6: Verificando variáveis de ambiente (PATH)..."
BASHRC="$HOME/.bashrc"
PATH_LINE="export PATH=/home/deck/.local/bin:\$PATH"
mkdir -p "$HOME/.local/bin"

if grep -Fxq "$PATH_LINE" "$BASHRC"; then
    log_skip "PATH já configurado em .bashrc."
else
    log_act "Adicionando PATH ao .bashrc..."
    echo "" >> "$BASHRC"
    echo "$PATH_LINE" >> "$BASHRC"
fi
export PATH=$HOME/.local/bin:$PATH

# ------------------------------------------------------------------------------
# 3. DISTROBOX (Verificação de Versão)
# ------------------------------------------------------------------------------
log_info "Passo 3/6: Verificando Distrobox..."

# Verifica versão instalada
if command -v distrobox >/dev/null; then
    DB_LOCAL_VER=$(distrobox --version | awk '{print $2}')
else
    DB_LOCAL_VER="0"
fi

# Verifica versão remota (GitHub API)
DB_REMOTE_VER=$(curl -s https://api.github.com/repos/89luca89/distrobox/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

if [ "$DB_LOCAL_VER" == "$DB_REMOTE_VER" ]; then
    log_skip "Distrobox já está na última versão ($DB_LOCAL_VER)."
    
    # Verifica configs mesmo se versão for igual
    if [ ! -s "$HOME/.distroboxrc" ]; then
        log_act "Recriando .distroboxrc ausente..."
        printf "xhost +si:localuser:\$USER >/dev/null\nexport PIPEWIRE_RUNTIME_DIR=/dev/null\nexport PATH=/home/deck/.local/bin:\$PATH\nexport PATH=\$PATH:/home/deck/.local/bin\n" > "$HOME/.distroboxrc"
    fi
else
    log_act "Atualizando Distrobox ($DB_LOCAL_VER -> $DB_REMOTE_VER)..."
    curl -s https://raw.githubusercontent.com/89luca89/distrobox/main/install | sh -s -- --prefix $HOME/.local
    
    # Garante criação do .distroboxrc na instalação
    if [ ! -s "$HOME/.distroboxrc" ]; then
        printf "xhost +si:localuser:\$USER >/dev/null\nexport PIPEWIRE_RUNTIME_DIR=/dev/null\nexport PATH=/home/deck/.local/bin:\$PATH\nexport PATH=\$PATH:/home/deck/.local/bin\n" > "$HOME/.distroboxrc"
    fi
fi

# ------------------------------------------------------------------------------
# 4. PODMAN LAUNCHER (Verificação de Versão via Recibo)
# ------------------------------------------------------------------------------
log_info "Passo 4/6: Verificando Podman Launcher..."
PODMAN_BIN="$HOME/.local/bin/podman"
VERSION_FILE="$HOME/.local/bin/.podman_installed_tag"

# Obtém Tag Remota (Redirecionamento do GitHub)
PM_LATEST_URL=$(curl -Ls -o /dev/null -w %{url_effective} https://github.com/89luca89/podman-launcher/releases/latest)
PM_REMOTE_TAG=$(echo $PM_LATEST_URL | grep -o 'v[0-9]*\.[0-9]*\.[0-9]*')

# Obtém Tag Local (se existir)
if [ -f "$VERSION_FILE" ] && [ -f "$PODMAN_BIN" ]; then
    PM_LOCAL_TAG=$(cat "$VERSION_FILE")
else
    PM_LOCAL_TAG="none"
fi

if [ "$PM_LOCAL_TAG" == "$PM_REMOTE_TAG" ]; then
    log_skip "Podman já está na última versão ($PM_LOCAL_TAG)."
else
    log_act "Instalando/Atualizando Podman ($PM_LOCAL_TAG -> $PM_REMOTE_TAG)..."
    DOWNLOAD_URL="https://github.com/89luca89/podman-launcher/releases/download/${PM_REMOTE_TAG}/podman-launcher-amd64"
    
    curl -L -o "$PODMAN_BIN" "$DOWNLOAD_URL"
    chmod +x "$PODMAN_BIN"
    
    # Salva o recibo da versão para a próxima verificação
    echo "$PM_REMOTE_TAG" > "$VERSION_FILE"
    log_success "Podman atualizado."
fi

# ------------------------------------------------------------------------------
# 5. CONFIGURAÇÃO DE PERMISSÕES (SUBUID/GID)
# ------------------------------------------------------------------------------
log_info "Passo 5/6: Verificando mapeamento de usuários..."

HAS_SUBUID=$(grep -c "^deck:" /etc/subuid 2>/dev/null)
if [ "$HAS_SUBUID" -gt 0 ]; then
    log_skip "Mapeamento subuid/subgid já configurado."
else
    log_act "Configurando mapeamento (Necessário senha sudo)..."
    sudo touch /etc/subuid /etc/subgid
    sudo usermod --add-subuid 100000-165535 --add-subgid 100000-165535 deck
fi

# ------------------------------------------------------------------------------
# 6. ÍCONES E PERMISSÕES FINAIS
# ------------------------------------------------------------------------------
log_info "Passo 6/6: Verificando pasta de ícones..."
ICON_DIR="$HOME/.local/share/icons"
mkdir -p "$ICON_DIR"

if [ -O "$ICON_DIR" ]; then
    log_skip "Permissões de ícones corretas."
else
    log_act "Corrigindo dono da pasta de ícones..."
    sudo chown deck:deck "$ICON_DIR"
fi

# ------------------------------------------------------------------------------
# RESUMO
# ------------------------------------------------------------------------------
echo ""
echo -e "${GREEN}=============================================================${NC}"
echo -e "${GREEN}                 VERIFICAÇÃO CONCLUÍDA                       ${NC}"
echo -e "${GREEN}=============================================================${NC}"
echo -e "Distrobox: ${BOLD}$(distrobox --version | awk '{print $2}')${NC}"
echo -e "Podman Tag:${BOLD} $(cat $VERSION_FILE 2>/dev/null || echo 'Erro')${NC}"
echo ""
