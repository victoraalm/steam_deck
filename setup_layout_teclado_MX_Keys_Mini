#!/bin/bash

# ==============================================================================
# SCRIPT DE CONFIGURAÇÃO DE LOCALIDADE, TECLADO E HORA (SMART)
# ==============================================================================

# ------------------------------------------------------------------------------
# 0. AUTO-RELAUNCH (Garante execução no terminal)
# ------------------------------------------------------------------------------
if [ -z "$TERM" ] || [ "$TERM" == "dumb" ]; then
    # Se não detectar um terminal válido, tenta abrir no Konsole
    if command -v konsole &> /dev/null; then
        konsole --hold -e bash -c "$(realpath "$0")"
        exit 0
    else
        echo "Este script precisa rodar em um terminal."
        exit 1
    fi
fi

# Cores e Formatação
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Variáveis de Status para o Resumo
STATUS_PASS="Verificado"
STATUS_KEYBOARD="Pular (Já configurado)"
STATUS_LOCALE="Pular (Já configurado)"
STATUS_TZ="Pular (Já configurado)"
STATUS_NTP="Pular (Já configurado)"

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_succ() { echo -e "${GREEN}[OK]${NC} $1"; }
log_skip() { echo -e "${YELLOW}[PULAR]${NC} $1"; }
log_act()  { echo -e "${GREEN}[AÇÃO]${NC} $1"; }
log_err()  { echo -e "${RED}[ERRO]${NC} $1"; }

echo -e "${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}   CONFIGURAÇÃO DE SISTEMA: TECLADO, DATA E HORA             ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

# ------------------------------------------------------------------------------
# 1. VERIFICAÇÃO DE SENHA (SUDO)
# ------------------------------------------------------------------------------
log_info "Verificando permissões de administrador..."

# Verifica status da senha (NP = No Password)
USER_PASS_STATUS=$(passwd -S $(whoami) | awk '{print $2}')

if [ "$USER_PASS_STATUS" == "NP" ]; then
    log_err "Usuário sem senha definida."
    echo -e "${YELLOW}O sistema requer senha para alterar data, hora e localidade permanentemente.${NC}"
    echo "Defina uma senha agora:"
    passwd
    if [ $? -ne 0 ]; then
        log_err "Falha ao criar senha. Abortando."
        exit 1
    fi
    STATUS_PASS="Senha Criada"
else
    log_succ "Senha já configurada."
fi

# Valida sudo
sudo -v
if [ $? -ne 0 ]; then log_err "Falha na autenticação sudo."; exit 1; fi

# ------------------------------------------------------------------------------
# 2. TECLADO (US INTERNATIONAL)
# ------------------------------------------------------------------------------
log_info "Verificando layout de teclado..."

# Verifica configuração atual do X11
CURRENT_LAYOUT=$(localectl status | grep "X11 Layout" | awk '{print $3}')
CURRENT_VARIANT=$(localectl status | grep "X11 Variant" | awk '{print $3}')

if [ "$CURRENT_LAYOUT" == "us" ] && [ "$CURRENT_VARIANT" == "alt-intl" ]; then
    log_skip "Teclado já está em US Alt-Intl."
else
    log_act "Configurando teclado para US (Alt-Intl)..."
    # Configura permanentemente
    sudo localectl set-x11-keymap us pc104 alt-intl
    # Aplica na sessão atual imediatamente
    setxkbmap -model pc104 -layout us -variant alt-intl
    STATUS_KEYBOARD="Atualizado"
fi

# ------------------------------------------------------------------------------
# 3. FUSO HORÁRIO (SÃO PAULO)
# ------------------------------------------------------------------------------
log_info "Verificando Fuso Horário..."

TARGET_TZ="America/Sao_Paulo"
CURRENT_TZ=$(timedatectl show -p Timezone --value)

if [ "$CURRENT_TZ" == "$TARGET_TZ" ]; then
    log_skip "Fuso horário já é $TARGET_TZ."
else
    log_act "Alterando fuso de $CURRENT_TZ para $TARGET_TZ..."
    sudo timedatectl set-timezone "$TARGET_TZ"
    STATUS_TZ="Atualizado para SP"
fi

# ------------------------------------------------------------------------------
# 4. SINCRONIZAÇÃO NTP (RELÓGIO AUTOMÁTICO)
# ------------------------------------------------------------------------------
log_info "Verificando sincronização de relógio (NTP)..."

NTP_ACTIVE=$(timedatectl show -p NTP --value)

if [ "$NTP_ACTIVE" == "yes" ]; then
    log_skip "Sincronização NTP já está ativa."
else
    log_act "Ativando NTP..."
    sudo timedatectl set-ntp true
    STATUS_NTP="Ativado"
fi

# ------------------------------------------------------------------------------
# 5. LOCALIDADE (IDIOMA DO SISTEMA)
# ------------------------------------------------------------------------------
log_info "Verificando idioma do sistema..."

TARGET_LANG="en_US.UTF-8"
CURRENT_LANG=$(localectl status | grep "System Locale" | grep -o "LANG=[^ ]*" | cut -d= -f2)

if [ "$CURRENT_LANG" == "$TARGET_LANG" ]; then
    log_skip "Idioma já é $TARGET_LANG."
else
    log_act "Alterando idioma para $TARGET_LANG..."
    sudo localectl set-locale LANG=$TARGET_LANG LC_TIME=$TARGET_LANG
    STATUS_LOCALE="Atualizado (Reinicie para aplicar)"
fi

# ------------------------------------------------------------------------------
# 6. RESUMO FINAL
# ------------------------------------------------------------------------------
echo ""
echo -e "${YELLOW}=============================================================${NC}"
echo -e "${YELLOW}                  RELATÓRIO DE MUDANÇAS                      ${NC}"
echo -e "${YELLOW}=============================================================${NC}"

echo -e "1. Senha/Sudo:       $STATUS_PASS"
echo -e "2. Teclado:          $STATUS_KEYBOARD"
echo -e "3. Fuso Horário:     $STATUS_TZ"
echo -e "4. Sincronização:    $STATUS_NTP"
echo -e "5. Idioma (Locale):  $STATUS_LOCALE"

echo ""
echo -e "${BLUE}Configuração atual do sistema:${NC}"
echo "------------------------------------------------"
localectl status | grep -E "X11 Layout|X11 Variant|System Locale"
timedatectl | grep -E "Time zone|NTP service"
echo "------------------------------------------------"
